# Ensure Apache listens on both HTTP and HTTPS ports
Listen 80
Listen 443

# Redirect all HTTP traffic to HTTPS
<VirtualHost *:80>
    ServerName buildprocure.com
    Redirect permanent / https://buildprocure.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName buildprocure.com
    ServerAlias localhost
    DocumentRoot /var/www/html

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/ssl/buildprocure.com_combined.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/ssl/_.buildprocure.com_private_key.key"

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Pass PHP requests to php-fpm
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://php-fpm:9000"
    </FilesMatch>

    # Forward HTTPS header for apps that depend on it (like SAML)
    RequestHeader set X-Forwarded-Proto "https"

    # Proxy SimpleSAMLphp service (if running separately)
    ProxyPass "/simplesaml/" "http://simplesamlphp/"
    ProxyPassReverse "/simplesaml/" "http://simplesamlphp/"
</VirtualHost>
