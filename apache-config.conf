# We only add HTTPS listener because httpd.conf already includes Listen 80
Listen 443

# Redirect all HTTP traffic to HTTPS
<VirtualHost *:80>
    ServerName buildprocure.com
    Redirect permanent / https://buildprocure.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName buildprocure.com
    ServerAlias localhost
    # DocumentRoot /var/www/html

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/ssl/buildprocure.com_combined.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/ssl/_.buildprocure.com_private_key.key"

    # Prevent directory listing and allow .htaccess
    # <Directory /var/www/html>
    #     Options -Indexes +FollowSymLinks
    #     AllowOverride All
    #     Require all granted
    #     DirectoryIndex index.php index.html
    # </Directory>
    DirectoryIndex index.php index.html
    # Send PHP requests to php-fpm container
    # <FilesMatch "\.php$">
    #     SetHandler "proxy:fcgi://php-fpm:9000"
    # </FilesMatch>
    
    
    # --------------------------
    # PHP-FPM proxy (no local files)
    # --------------------------
    ProxyPassMatch ^/(.*\.php)$ fcgi://php-fpm:9000/var/www/html/$1
    DirectoryIndex index.php

    # Forward HTTPS info to PHP for SAML and other frameworks
    SetEnv HTTPS on
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Forwarded-Host "buildprocure.com"
    # -------------------------------------------------
    # Reverse proxy to SimpleSAMLphp container
    # (runs HTTP only, port 80 internally)
    # -------------------------------------------------

    ProxyPreserveHost On

    # Map /simplesaml/ URLs on the main domain to /simplesamlphp/www/ in the container
    ProxyPass "/simplesaml/" "http://simplesamlphp/simplesamlphp/www/"
    ProxyPassReverse "/simplesaml/" "http://simplesamlphp/simplesamlphp/www/"

    # ProxyPreserveHost On
    # ProxyPass "/simplesaml/" "http://simplesamlphp/"
    # ProxyPassReverse "/simplesaml/" "http://simplesamlphp/"

    # ProxyPass "/sso_index.php" "http://simplesamlphp/sso_index.php"
    # ProxyPassReverse "/sso_index.php" "http://simplesamlphp/sso_index.php"

    # âœ… Fixed log paths for httpd:2.4 base image
    ErrorLog /usr/local/apache2/logs/buildprocure_error.log
    CustomLog /usr/local/apache2/logs/buildprocure_access.log combined

    # -------------------------------------------------
    # Security headers (optional but recommended)
    # -------------------------------------------------
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff


        # Modules
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so

</VirtualHost>
